# Chunked Stream Transformers

[![CircleCI](https://circleci.com/gh/bunchtogether/chunked-stream-transformers.svg?style=svg)](https://circleci.com/gh/bunchtogether/chunked-stream-transformers) [![npm version](https://badge.fury.io/js/chunked-stream-transformers.svg)](http://badge.fury.io/js/chunked-stream-transformers)

Transform a stream into small chunks, then reassemble chunks to recreate the original stream.

Extends the Node.js stream [Transform](https://nodejs.org/api/stream.html#stream_class_stream_transform) and has no dependencies.

If you encounter an issue, fork the repository, [write tests demonstrating](https://github.com/bunchtogether/chunked-stream-transformers/tree/master/tests) the issue, and create a [pull request](https://github.com/bunchtogether/chunked-stream-transformers).

```js

const {
  SerializeTransform,
  DeserializeTransform,
} = require('@bunchtogether/chunked-stream-transformers');
const crypto = require('crypto');

const serializeTransform = new SerializeTransform({
  maxChunkSize: 1024,
});

const deserializeTransform = new DeserializeTransform({
  timeout: 1000,
});

// 10 MB buffer
const originalBuffer = crypto.randomBytes(10 * 1024 * 1024);

// The serialize transform will chunk to a consistent size
// and add a 10 byte header
serializeTransform.on('data', (chunk) => {
  expect(chunk.length).toBeLessThanOrEqual(1024);
  setTimeout(() => {
    deserializeTransform.write(chunk);
  }, Math.random() * 100);
});

// The deserialize transform will reorder the chunks
// and recreate the original buffer
deserializeTransform.on('data', (receivedBuffer) => {
  expect(receivedBuffer.length).toEqual(10 * 1024 * 1024);
});

serializeTransform.write(originalBuffer);
```

## Install

`yarn add chunked-stream-transformers`

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [ChunkTimeoutError](#chunktimeouterror)
-   [ChunkIncompleteError](#chunkincompleteerror)
-   [SerializeTransform](#serializetransform)
    -   [Parameters](#parameters)
-   [DeserializeTransform](#deserializetransform)
    -   [Parameters](#parameters-1)

### ChunkTimeoutError

**Extends Error**

Emitted by DeserializeTransform streams when the time after the last
byte in a chunk received exeeds the 'timeout' parameter

### ChunkIncompleteError

**Extends Error**

Emitted by DeserializeTransform streams that are ended while chunks are
in progress

### SerializeTransform

**Extends Transform**

Ingests data of any size, emits consistently sized chunks containing
a 10 byte header used by DeserializeTransform to reconstruct the original
stream

#### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Transform stream options, see [Node.js documentation](https://nodejs.org/api/stream.html#stream_class_stream_transform) for full documentation (optional, default `{maxChunkSize:1316}`)
    -   `options.maxChunkSize` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Maximum size in bytes of emitted chunks, including a 10 byte header. (optional, default `1316`)

### DeserializeTransform

**Extends Transform**

Ingests consistently sized chunks generated by SerializeTransform
and emits the original, larger chunks

#### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Transform stream options, see [Node.js documentation](https://nodejs.org/api/stream.html#stream_class_stream_transform) for full documentation (optional, default `{timeout:5000}`)
    -   `options.timeout` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Maximum size in bytes of emitted chunks, including a 10 byte header. (optional, default `5000`)
